from time import sleep

import framebuf
from machine import Timer
from ssd1306 import SSD1306_I2C


class Image:
    def __init__(self, width: int, height: int, buffer: bytearray) -> None:
        self.width = width
        self.height = height
        self.buffer = framebuf.FrameBuffer(
            buffer,
            width,
            height,
            framebuf.MONO_HLSB,
        )

    def get_width_center(self, width: int) -> int:
        return (width - self.width) // 2

    def get_height_center(self, height: int) -> int:
        return (height - self.height) // 2


class AnimatedFrames:
    """A collection of frames of equal size for playing an animated video."""

    def __init__(self, frames: tuple[Image, ...], duration_seconds: float) -> None:
        self.frames = frames
        self.duration = duration_seconds
        self._timer = Timer()
        if frames:
            reference = frames[0]
            self.width = reference.width
            self.height = reference.height
            self.get_width_center = reference.get_width_center
            self.get_height_center = reference.get_height_center

    def start_animation(self, display: SSD1306_I2C, x: int, y: int) -> None:
        # Time.init callback expects one positional argument
        def play_frames(t):
            for frame in self.frames:
                display.blit(frame.buffer, x, y)
                display.show()
                sleep(time_between_frames)

        time_between_frames = self.duration / len(self.frames)
        milliseconds = int(self.duration * 1000)
        self._timer.init(mode=Timer.PERIODIC, period=milliseconds, callback=play_frames)

    def end_animation(self) -> None:
        self._timer.deinit()


# fmt: off
# 'error_wifi_icon', 29x23px
_error_wifi_icon = bytearray((
0x00, 0x3c, 0x00, 0x00, 0x03, 0xf8, 0xc0, 0x60, 0x0f, 0xf8, 0xe0, 0xe0, 0x3f, 0xfc, 0x71, 0xc0, 
0x7f, 0xfe, 0x3b, 0x80, 0xff, 0xc0, 0x1f, 0x18, 0xfe, 0x00, 0x0e, 0x38, 0x78, 0x00, 0x1f, 0x10, 
0x30, 0x1e, 0x3b, 0x80, 0x00, 0xfc, 0x71, 0xc0, 0x01, 0xf8, 0xe0, 0xe0, 0x03, 0xf8, 0xc4, 0x60, 
0x03, 0xfc, 0x0e, 0x00, 0x03, 0xe0, 0x1e, 0x00, 0x01, 0x80, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x07, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x1f, 0xc0, 0x00, 
0x00, 0x1f, 0xc0, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x07, 0x00, 0x00, 
))
WIFI_ICON_ERROR = Image(29, 23, _error_wifi_icon)

# 'low_wifi_icon', 29x23px
_low_wifi_icon = bytearray((
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x07, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x1f, 0xc0, 0x00, 
0x00, 0x1f, 0xc0, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x07, 0x00, 0x00, 
))
WIFI_ICON_LOW = Image(29, 23, _low_wifi_icon)

# 'medium_wifi_icon', 29x23px
_medium_wifi_icon = bytearray((
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x1f, 0xc0, 0x00, 0x00, 0xff, 0xf8, 0x00, 0x01, 0xff, 0xfc, 0x00, 0x03, 0xff, 0xfe, 0x00, 
0x03, 0xff, 0xfe, 0x00, 0x03, 0xe0, 0x3e, 0x00, 0x01, 0x80, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x07, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x1f, 0xc0, 0x00, 
0x00, 0x1f, 0xc0, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x07, 0x00, 0x00, 
))
WIFI_ICON_MEDIUM = Image(29, 23, _medium_wifi_icon)

# 'full_wifi_icon', 29x23px
_full_wifi_icon = bytearray((
0x00, 0x3f, 0xe0, 0x00, 0x03, 0xff, 0xfe, 0x00, 0x0f, 0xff, 0xff, 0x80, 0x3f, 0xff, 0xff, 0xe0, 
0x7f, 0xff, 0xff, 0xf0, 0xff, 0xc0, 0x1f, 0xf8, 0xfe, 0x00, 0x03, 0xf8, 0x78, 0x00, 0x00, 0xf0, 
0x30, 0x1f, 0xc0, 0x60, 0x00, 0xff, 0xf8, 0x00, 0x01, 0xff, 0xfc, 0x00, 0x03, 0xff, 0xfe, 0x00, 
0x03, 0xff, 0xfe, 0x00, 0x03, 0xe0, 0x3e, 0x00, 0x01, 0x80, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x07, 0x00, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x1f, 0xc0, 0x00, 
0x00, 0x1f, 0xc0, 0x00, 0x00, 0x0f, 0x80, 0x00, 0x00, 0x07, 0x00, 0x00
))
WIFI_ICON_FULL = Image(29, 23, _full_wifi_icon)


WIFI_ANIMATION = AnimatedFrames((WIFI_ICON_LOW, WIFI_ICON_MEDIUM, WIFI_ICON_FULL), duration_seconds=1)
